#ifndef CMR_REGULAR_H
#define CMR_REGULAR_H

/**
 * \file regular.h
 *
 * \author Matthias Walter and Klaus Truemper
 *
 * \brief Recognition of [regular matrices](\ref regular).
 */

#ifdef __cplusplus
extern "C" {
#endif

#include <cmr/env.h>
#include <cmr/matrix.h>
#include <cmr/matroid.h>
#include <cmr/graph.h>
#include <cmr/series_parallel.h>
#include <cmr/graphic.h>
#include <cmr/network.h>

typedef enum
{
  CMR_DEC_CONSTRUCT_NONE = 0,
  CMR_DEC_CONSTRUCT_LEAVES = 1,
  CMR_DEC_CONSTRUCT_ALL = 2,
} CMR_DEC_CONSTRUCT;

typedef struct
{
  bool directGraphicness;       /**< \brief Whether to use fast graphicness routines; default: \c true */
  bool seriesParallel;          /**< \brief Whether to allow series-parallel operations in the decomposition tree;
                                 **         default: \c true */
  bool planarityCheck;          /**< \brief Whether minors identified as graphic should still be checked for
                                 **         cographicness; default: \c false. */
  bool completeTree;            /**< \brief Whether to compute a complete decomposition tree (even if already
                                 **         non-regular; default: \c false. */
  CMR_DEC_CONSTRUCT matrices;   /**< \brief Which matrices of the decomposition to construct; default:
                                 **         \ref CMR_DEC_CONSTRUCT_NONE. */
  CMR_DEC_CONSTRUCT transposes; /**< \brief Which transposed matrices of the decomposition to construct; default:
                                 **         \ref CMR_DEC_CONSTRUCT_NONE. */
  CMR_DEC_CONSTRUCT graphs;     /**< \brief Which (co)graphs to construct; default: \ref CMR_DEC_CONSTRUCT_NONE. */
} CMR_REGULAR_PARAMS;

/**
 * \brief Initializes the default parameters for regularity testing.
 *
 * These are selected for minimum running time.
 */

CMR_EXPORT
CMR_ERROR CMRregularParamsInit(
  CMR_REGULAR_PARAMS* params  /**< Pointer to parameters. */
);

/**
 * \brief Statistics for regular matroid recognition algorithm.
 */

typedef struct
{
  uint32_t totalCount;                  /**< Total number of invocations. */
  double totalTime;                     /**< Total time of all invocations. */
  CMR_SP_STATISTICS seriesParallel;     /**< Statistics for series-parallel algorithm. */
  CMR_GRAPHIC_STATISTICS graphic;       /**< Statistics for direct (co)graphic checks. */
  CMR_NETWORK_STATISTICS network;       /**< Statistics for direct (co)network checks. */
  uint32_t sequenceExtensionCount;      /**< Number of extensions of sequences of nested minors. */
  double sequenceExtensionTime;         /**< Time of extensions of sequences of nested minors. */
  uint32_t sequenceGraphicCount;        /**< Number (co)graphicness tests applied to sequence of nested minors. */
  double sequenceGraphicTime;           /**< Time of (co)graphicness tests applied to sequence of nested minors. */
  uint32_t enumerationCount;            /**< Number of calls to enumeration algorithm for candidate 3-separations. */
  double enumerationTime;               /**< Time of enumeration of candidate 3-separations. */
  uint32_t enumerationCandidatesCount;  /**< Number of enumerated candidates for 3-separations. */
} CMR_REGULAR_STATS;


/**
 * \brief Initializes all statistics for regularity test computations.
 */

CMR_EXPORT
CMR_ERROR CMRregularStatsInit(
  CMR_REGULAR_STATS* stats /**< Pointer to statistics. */
);

/**
 * \brief Prints statistics for regularity test computations.
 */

CMR_EXPORT
CMR_ERROR CMRregularStatsPrint(
  FILE* stream,             /**< File stream to print to. */
  CMR_REGULAR_STATS* stats, /**< Pointer to statistics. */
  const char* prefix        /**< Prefix string to prepend to each printed line (may be \c NULL). */
);
  
/**
 * \brief Tests binary linear matroid for regularity.
 *
 * If \p pdec is not \c NULL, \c *pdec will be a (partial) decomposition tree.
 * If \p completeTree is \c true, then the decomposition tree is complete. Otherwise, it must only contain sufficient
 * information in order to determine regularity.
 *
 * If \p pminor is not \c NULL and \p matrix is not regular, then an \f$ F_7 \f$ or \f$ F_7^\star \f$ minor is searched.
 * This causes additional computational effort!
 */

CMR_EXPORT
CMR_ERROR CMRregularTest(
  CMR* cmr,                   /**< \ref CMR environment. */
  CMR_CHRMAT* matrix,         /**< Input matrix. */
  bool *pisRegular,           /**< Pointer for storing whether \p matrix is regular. */
  CMR_MATROID_DEC** pdec,     /**< Pointer for storing the decomposition tree (may be \c NULL). */
  CMR_MINOR** pminor,         /**< Pointer for storing an \f$ F_7 \f$ or \f$ F_7^\star \f$ minor. */
  CMR_REGULAR_PARAMS* params, /**< Parameters for the computation (may be \c NULL for defaults). */
  CMR_REGULAR_STATS* stats,   /**< Statistics for the computation (may be \c NULL). */
  double timeLimit            /**< Time limit to impose. */
);

#ifdef __cplusplus
}
#endif

#endif /* CMR_REGULAR_H */

